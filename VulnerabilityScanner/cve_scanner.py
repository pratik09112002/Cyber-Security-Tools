import requests
import sys
from typing import List, Dict, Any, Optional, Tuple

NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0"
MAX_PAGES = 3          # safety limit so we don't spam the API
RESULTS_PER_PAGE = 20  # how many CVEs per page

SEVERITY_ORDER = {
    "CRITICAL": 4,
    "HIGH": 3,
    "MEDIUM": 2,
    "LOW": 1,
    "UNKNOWN": 0,
}


def get_min_severity_from_user() -> str:
    print("\nFilter by minimum severity:")
    print("1) CRITICAL")
    print("2) HIGH")
    print("3) MEDIUM")
    print("4) LOW")
    print("5) No filter (show all)")
    choice = input("Choose option (1-5): ").strip()

    mapping = {
        "1": "CRITICAL",
        "2": "HIGH",
        "3": "MEDIUM",
        "4": "LOW",
        "5": "UNKNOWN",  # treat as show all
    }
    return mapping.get(choice, "UNKNOWN")


def fetch_cves(
    keyword: str,
    min_severity: str = "UNKNOWN",
    max_pages: int = MAX_PAGES,
) -> List[Dict[str, Any]]:
    """
    Fetch CVEs from NVD using a keyword search, with basic pagination.
    Intended for learning/demo use; heavy use should respect NVD API key and rate limits.
    """
    start_index = 0
    all_vulns: List[Dict[str, Any]] = []

    print(f"\n[+] Searching NVD for: '{keyword}'")
    print(f"[+] Minimum severity filter: {min_severity}\n")

    for _ in range(max_pages):
        params = {
            "keywordSearch": keyword,
            "resultsPerPage": RESULTS_PER_PAGE,
            "startIndex": start_index,
        }

        try:
            resp = requests.get(NVD_API_URL, params=params, timeout=20)
            resp.raise_for_status()
        except requests.RequestException as e:
            print(f"[!] Error contacting NVD API: {e}")
            break

        data = resp.json()
        vulns = data.get("vulnerabilities", [])
        if not vulns:
            break

        # Filter by severity before storing
        for item in vulns:
            sev, _ = extract_severity_and_score(item.get("cve", {}))
            if SEVERITY_ORDER.get(sev, 0) >= SEVERITY_ORDER.get(min_severity, 0):
                all_vulns.append(item)

        total_results = data.get("totalResults", 0)
        start_index += RESULTS_PER_PAGE
        if start_index >= total_results:
            break

    return all_vulns


def extract_severity_and_score(cve: Dict[str, Any]) -> Tuple[str, Optional[float]]:
    """
    Try to extract severity and score from CVSS v3.1, then v3.0, then v2.
    """
    metrics = cve.get("metrics", {})
    severity = "UNKNOWN"
    score: Optional[float] = None

    for key in ("cvssMetricV31", "cvssMetricV30", "cvssMetricV2"):
        if key in metrics and metrics[key]:
            metric = metrics[key][0]
            cvss_data = metric.get("cvssData", {})
            sev = cvss_data.get("baseSeverity")
            sc = cvss_data.get("baseScore")
            if sev:
                severity = sev
            if sc is not None:
                score = sc
            break

    return severity, score


def print_cve_summary(vulns: List[Dict[str, Any]]) -> None:
    if not vulns:
        print("\n[-] No CVEs matched your criteria (or NVD returned none).")
        return

    print(f"\n[+] Showing {len(vulns)} CVEs (after filtering):\n")

    for item in vulns:
        cve = item.get("cve", {})
        cve_id = cve.get("id", "UNKNOWN")
        severity, score = extract_severity_and_score(cve)

        print(f"CVE: {cve_id}")

        if severity == "UNKNOWN" and score is None:
            print("Severity: Not scored in NVD (no CVSS data)")
        else:
            print(f"Severity: {severity} (score: {score})")

        descs = cve.get("descriptions", [])
        if descs:
            text = descs[0].get("value", "")
            short = text.split(".")[0][:180]
            print(f"Summary: {short}...")

        refs = cve.get("references", [])
        if refs:
            url = refs[0].get("url")
            if url:
                print(f"Reference: {url}")

        print("-" * 80)


def main() -> None:
    print("=== Advanced CVE Vulnerability Scanner (Demo) ===")
    product = input("Enter product name (e.g., apache, openssl, nginx): ").strip()
    version = input("Enter version (optional, press Enter to skip): ").strip()

    if not product:
        print("Product name is required.")
        sys.exit(1)

    keyword = product if not version else f"{product} {version}"
    min_sev = get_min_severity_from_user()

    vulns = fetch_cves(keyword, min_severity=min_sev)
    print_cve_summary(vulns)


if __name__ == "__main__":
    main()
